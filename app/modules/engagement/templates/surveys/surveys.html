{% extends 'core/sidebar.html' %}
{% load staticfiles %}
{% load core_filters %}

{% block brand %}
  <h1>
    Surveys
    <small>View surveys</small>
  </h1>
{% endblock %}

{% block includes %}
<link rel="stylesheet" href="{% static 'global/ui/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css' %}">
{% endblock %}
{% block content %}

<div class="nav-tabs-custom">
  <ul class="nav nav-tabs">
    <li class="active">
      <a data-toggle="tab" href="#all_surveys">
        All
      </a>
    </li>
    {% for group in groups %}
    <li>
      <a data-toggle="tab" href="#group_{{group.pk}}">
        {{ group.name }}
      </a>
    </li>
    {% endfor %}
  </ul>
</div>

<div class="tab-content box">
    <div id="all_surveys" class="tab-pane fade in active box-body">
      <table class="table">
        <thead>
          <th scope="col">Date</th>
          <th scope="col">Name</th>
          <th scope="col">Group</th>
          <th scope="col">Actions</th>
        </thead>
        <tbody>
          {% for survey in surveys %}
          <tr class="survey_row {% if survey.is_expired %} expired {% endif %}" {% if survey.is_expired %} hidden {% endif %}>
            <td data-order="{{ survey.date_created.isoformat }}">{{ survey.date_created|date:"M d" }}</td>
            <td>{{survey.name}}</td>
            <td>{{survey.group}}</td>
            <td>
              <button onclick="location.href='{% url 'view-survey' survey.pk %}'" class="btn btn-info" data-toggle="tooltip" data-placement="top" title="View"><i class="fa fa-fw fa-eye"></i></button>
              <button onclick="copyStringToClipboard('{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% url 'redirect-survey' survey.pk %}')" class="btn btn-info" data-toggle="tooltip" data-placement="top" title="Copy Survey Link"><i class="fa fa-fw fa-user-circle"></i></button>
              <button onclick="copyStringToClipboard('{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% url 'complete-survey' survey.pk %}?survey_key={{survey.survey_key}}')" class="btn btn-info" data-toggle="tooltip" data-placement="top" title="Copy Completion Link"><i class="fa fa-fw fa-key"></i></button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% for group in groups %}
    <div id="group_{{group.pk}}" class="tab-pane fade in box-body">
      <table class="table">
        <thead>
          <th scope="col">Date</th>
          <th scope="col">Name</th>
          <th scope="col">Guild</th>
          <th scope="col">Actions</th>
        </thead>
        <tbody>
          {% for survey in surveys %}
          {% if survey.group == group %}
          <tr class="survey_row {% if survey.is_expired %} expired {% endif %}" {% if survey.is_expired %} hidden {% endif %}>
            <td data-order="{{ survey.date_created.isoformat }}">{{ survey.date_created|date:"M d" }}</td>
            <td>{{survey.name}}</td>
            <td>{{survey.group}}</td>
            <td>
              <button onclick="location.href='{% url 'view-survey' survey.pk %}'" class="btn btn-info" data-toggle="tooltip" data-placement="top" title="View"><i class="fa fa-fw fa-eye"></i></button>
              <button onclick="copyStringToClipboard('{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% url 'redirect-survey' survey.pk %}')" class="btn btn-info" data-toggle="tooltip" data-placement="top" title="Copy Survey Link"><i class="fa fa-fw fa-user-circle"></i></button>
              <button onclick="copyStringToClipboard('{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% url 'complete-survey' survey.pk %}?survey_key={{survey.survey_key}}')" class="btn btn-info" data-toggle="tooltip" data-placement="top" title="Copy Completion Link"><i class="fa fa-fw fa-key"></i></button>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endfor %}
</div>
<button id="unhide_button" onclick="unhideSurveys()" class="btn btn-info pull-right" title="Show all surveys">Show hidden surveys</button>
<button id="hide_button" onclick="hideSurveys()" class="btn btn-default pull-right" title="Hide expired surveys" style="display: none;">Hide expired surveys</button>
{% endblock %}

{% block scripts %}
<script>
$(function () {
    $('table').DataTable({
      'paging'      : false,
      'lengthChange': false,
      'searching'   : true,
      'ordering'    : true,
      'info'        : false,
      'autoWidth'   : false,
      'order' : [[ 1, 'asc' ]],
      'columnDefs' : [
        { 'orderable' : false, 'targets' : 0 }
      ]
    })

    $('[data-toggle="tooltip"]').tooltip()
 })

function copyStringToClipboard (str) {
   // Create new element
   var el = document.createElement('textarea');
   // Set value (string to be copied)
   el.value = str;
   // Set non-editable to avoid focus and move outside of view
   el.setAttribute('readonly', '');
   el.style = {position: 'absolute', left: '-9999px'};
   document.body.appendChild(el);
   // Select text inside element
   el.select();
   // Copy text to clipboard
   document.execCommand('copy');
   // Remove temporary element
   document.body.removeChild(el);
}

function unhideSurveys() {
  elements = document.getElementsByClassName("survey_row")
  for (i=0; i<elements.length; i++) {
    elements[i].removeAttribute("hidden")
  }
  document.getElementById("unhide_button").style.display = "none"
  document.getElementById("hide_button").style.display = "block"
}

function hideSurveys() {
  elements = document.getElementsByClassName("expired")
  for (i=0; i<elements.length; i++) {
    elements[i].setAttribute("hidden", true)
  }
  document.getElementById("unhide_button").style.display = "block"
  document.getElementById("hide_button").style.display = "none"
}
</script>
<script src="{% static 'global/ui/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'global/ui/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
{% endblock %}
